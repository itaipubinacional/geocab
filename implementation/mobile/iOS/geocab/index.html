<!doctype html>
<html lang="en">
<head>
	<link rel="stylesheet" href="ol.css">
	<link rel="stylesheet" href="jquery.mobile-1.4.4.min.css">
	<link rel="stylesheet" href="style.css">
	<title>Geocab</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
</head>
<body style="margin: 0">
	<div data-role="popup" id="popupCloseLeft" class="ui-content" style="max-width:280px">

	    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>

		<div data-role="collapsibleset" id="collapsible-content" >
		</div>
	</div>

	<div id="map" class="map">
	</div>
    
    <img id="map-loading-gif" src="ajax-loader.gif" alt="" style="display:none;">
    
    <script src="jquery-2.1.1.min.js"></script>
    <script src="ol.js"></script>
    <script src="jquery.mobile-1.4.4.js"></script>
	
	<script type="text/javascript">
	
		var view = new ol.View({
		  center: ol.proj.transform([-54.1394, -24.7568], 'EPSG:4326', 'EPSG:3857'),
          zoom: 7
		});

		var layersAdd = [];
		var markersAdd = [];
        var loadingFeature = false;
		
		var map = new ol.Map({
			target: 'map',
			layers: [
			new ol.layer.Tile({
				//source: new ol.source.MapQuest({layer: 'sat'})
				source: new ol.source.OSM()
			})],
			// rotação
            interactions: ol.interaction.defaults({altShiftDragRotate:false, pinchRotate:false, keyboard: false}),
			view: view,
			control: ol.control.defaults({rotate: false})

		});

		$( "#popupCloseLeft" ).bind({
		   popupafterclose: function(event, ui) { 
		   		$('#collapsible-content').html('');
		   }
		});
		
		// display popup on click
		map.on('click', function(evt) {
			if (!loadingFeature) {
				features = [];
				features.push(map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
					return feature;
				}))

	            var listUrls = [];
	            var listTitles = [];
	               
				if (layersAdd.length > 0){

	                for(var i in layersAdd)
	                {
	                    var url = layersAdd[i].wmsSource.getGetFeatureInfoUrl(
	                        evt.coordinate, view.getResolution(), view.getProjection(),
	                        {'INFO_FORMAT': 'application/json'});

	                    listUrls.push(decodeURIComponent(url));
	                    listTitles.push(layersAdd[i].title);
	                }

	            }
	            var collapsed = false;
				if (features.length > 0 && features[0] != undefined) {
					var html = '';
					loadingFeature = true;
					$("#map-loading-gif").show();
					for ( var i = 0; i < features.length; i++) {
						getMarkerAtributes(features[i].get('markerId'), features[i].get('name'), features[i].get('user'), features[i].get('created'));
						collapsed = true;
					}
				}

				if (listUrls.length > 0) {
					var collapsed = true;
                    loadingFeature = true;
                    $("#map-loading-gif").show();
					for (var i in listUrls) {
						getExternalLayerAttributes(listUrls[i], listTitles[i], collapsed);
						collapsed = true;
					}
				}
			}
		});

		function tapholdHandler( event ){
			var getPosition = false;
			map.on('click', function(evt) {
				if( !getPosition )  {
					var lat = evt.coordinate[0];
					var lon = evt.coordinate[1];
					getPosition = true;
					confirmToProceed(lat, lon);
				}
			});
		}
		
		function unbindTouchEvent() {
			$( "div.map" ).unbind( "taphold" );
			map.on('click', function(evt) {
				return null;
			});
		}

		function bindTouchEvent() {
			$( "div.map" ).bind( "taphold", tapholdHandler );
		}

		function showMarker(latitude, longitude, id, name, image, user, date, checked)
		{
			if (checked) {
					// if (fromTap == true) {
				var point = new ol.geom.Point([latitude, longitude])
				// } else {
				// var point = new ol.geom.Point(ol.proj.transform([longitude, latitude], 'EPSG:4326', 'EPSG:3857'))
				// }
				
				var iconFeature = new ol.Feature({
					geometry: point,
					name: name,
					user: user,
					created: date,
					markerId: id
				});

				//create the style
				var iconStyle = new ol.style.Style({
					image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
					src: image
					}))
				});

				var vectorSource = new ol.source.Vector({
						features: [iconFeature]
				});

				//add the feature vector to the layer vector, and apply a style to whole layer
				var vectorLayer = new ol.layer.Vector({
					source: vectorSource,
					style: iconStyle
				});

				map.addLayer(vectorLayer);
				markersAdd.push({'vectorLayer': vectorLayer, 'name': name});
				// if (!fromTap) zoomToArea(latitude, longitude);
			} else {
				for( var i in markersAdd ) {
				   if( markersAdd[i].name == name ) {
					   map.removeLayer(markersAdd[i].vectorLayer);
					   markersAdd.splice(i,1);  /* removed to prevent an error, the splice is called before the map.removeLayer finish the execution */
				   }
			   }
			}
			
		}

		function showLayer(url, name, title, checked) {
			if( checked == 'true') {
				var wmsSource = new ol.source.TileWMS({
					url: url,
					params: {'LAYERS': name},
				});

				var wmsLayer = new ol.layer.Tile({
					source: wmsSource
				});

				map.addLayer(wmsLayer);

				layersAdd.push({'wmsLayer': wmsLayer, 'wmsSource': wmsSource, 'name': name, 'title': title});
			} else {
			   for( var i in layersAdd ) {
				   if( layersAdd[i].name == name ) {
					   map.removeLayer(layersAdd[i].wmsLayer);
					   layersAdd.splice(i,1);
				   }
			   }
			}

		}

        function loadPopupContent (html) {
        	$('#popupCloseLeft').popup('open');
        	$('#collapsible-content').append(html).trigger("create");
            cancelLoading();
        }
    
        function cancelLoading() {
            loadingFeature = false;
            $("#map-loading-gif").hide();
        }

        function loadImageContent(id, html){
        	$('#marker-image-' + id).fadeOut("slow", function(){
			  $('#marker-image-' + id).replaceWith(html);
			  $('#marker-image-' + id).fadeIn("slow");
			});
        }
        
        function zoomToArea(latitude, longitude) {
			var pan = ol.animation.pan({
				source: view.getCenter()
			});
			var coordinates = ol.proj.transform([longitude, latitude], 'EPSG:4326', 'EPSG:3857');
			map.beforeRender(pan);
			view.setCenter(coordinates);
			view.setZoom(14);
		}
	</script>

</body>
</html>
